SELECT
    month,
    sum(taobao_gmv) AS `淘宝GMV`,
    sum(taobao_fee) AS `淘宝服务费`,
    sum(taobao_order_num) AS `淘宝订单量`,
    
    sum(jingdong_gmv) AS `京东GMV`,
    sum(jingdong_fee) AS `京东服务费`,
    sum(jingdong_order_num) AS `京东订单量`,
    
    sum(suning_gmv) AS `苏宁GMV`,
    sum(suning_fee) AS `苏宁服务费`,
    sum(suning_order_num) AS `苏宁订单量`,
    
    sum(pinduoduo_gmv) AS `拼多多GMV`,
    sum(pinduoduo_fee) AS `拼多多服务费`,
    sum(pinduoduo_order_num) AS `拼多多订单量`,
    
    sum(douyin_gmv) AS `抖音GMV`,
    sum(douyin_fee) AS `抖音服务费`,
    sum(douyin_order_num) AS `抖音订单量`,
    
    sum(kuaishou_gmv) AS `快手GMV`,
    sum(kuaishou_fee) AS `快手服务费`,
    sum(kuaishou_order_num) AS `快手订单量`,
    
    sum(taobao_gmv)+sum(jingdong_gmv)+sum(suning_gmv)+sum(pinduoduo_gmv)+sum(douyin_gmv)+sum(kuaishou_gmv) as `总GMV`,
    sum(taobao_fee)+sum(jingdong_fee)+sum(suning_fee)+sum(pinduoduo_fee)+sum(douyin_fee)+sum(kuaishou_fee) as `总服务费`,
    sum(taobao_order_num)+sum(jingdong_order_num)+sum(suning_order_num)+sum(pinduoduo_order_num)+sum(douyin_order_num)+sum(kuaishou_order_num) as `总订单量`
FROM
(
    SELECT
        month,
        toFloat64(sumIf(gmv,platform ='taobao')) AS taobao_gmv,
        toFloat64(sumIf(service_fee,platform ='taobao')) AS taobao_fee,
        toUInt64(sumIf(order_num,platform ='taobao')) AS taobao_order_num,
        
        toFloat64(sumIf(gmv,platform ='jingdong')) AS jingdong_gmv,
        toFloat64(sumIf(service_fee,platform ='jingdong')) AS jingdong_fee,
        toUInt64(sumIf(order_num,platform ='jingdong')) AS jingdong_order_num,
        
        toFloat64(sumIf(gmv,platform ='suning')) AS suning_gmv,
        toFloat64(sumIf(service_fee,platform ='suning')) AS suning_fee,
        toUInt64(sumIf(order_num,platform ='suning')) AS suning_order_num,
        
        toFloat64(sumIf(gmv,platform ='pinduoduo')) AS pinduoduo_gmv,
        toFloat64(sumIf(service_fee,platform ='pinduoduo')) AS pinduoduo_fee,
        toUInt64(sumIf(order_num,platform ='pinduoduo')) AS pinduoduo_order_num,
        
        toFloat64(sumIf(gmv,platform ='douyin')) AS douyin_gmv,
        toFloat64(sumIf(service_fee,platform ='douyin')) AS douyin_fee,
        toUInt64(sumIf(order_num,platform ='douyin')) AS douyin_order_num,
        
        toFloat64(sumIf(gmv,platform ='kuaishou')) AS kuaishou_gmv,
        toFloat64(sumIf(service_fee,platform ='kuaishou')) AS kuaishou_fee,
        toUInt64(sumIf(order_num,platform ='kuaishou')) AS kuaishou_order_num
    FROM dws_order_detail_di AS di
    WHERE 1 = 1
        $if(begin_date)$
            AND day >= $begin_date$
        $else$
            AND day >= '2021-06-01'
        $endif$   
        $if(end_date)$
            AND day <= $end_date$
        $else$
            AND day <= now() 
        $endif$
    GROUP BY formatDateTime(day, '%Y-%m') as month
    UNION ALL
    SELECT
        month,
        sum(taobao_gmv) AS taobao_gmv,
        sum(taobao_fee) AS taobao_fee,
        toUInt64(SUM(taobao_order_num)) AS taobao_order_num,
        
        sum(jingdong_gmv) AS jingdong_gmv,
        sum(jingdong_fee) AS jingdong_fee,
        toUInt64(SUM(jingdong_order_num)) AS jingdong_order_num,
        
        sum(suning_gmv) AS suning_gmv,
        sum(suning_fee) AS suning_fee,
        toUInt64(SUM(suning_order_num)) AS suning_order_num,
        
        sum(pinduoduo_gmv) AS pinduoduo_gmv,
        sum(pinduoduo_fee) AS pinduoduo_fee,
        toUInt64(SUM(pinduoduo_order_num)) AS pinduoduo_order_num,
        
        sum(douyin_gmv) AS douyin_gmv,
        sum(douyin_fee) AS douyin_fee,
        toUInt64(SUM(douyin_order_num)) AS douyin_order_num,
        
        sum(kuaishou_gmv) AS kuaishou_gmv,
        sum(kuaishou_fee) AS kuaishou_fee,
        toUInt64(SUM(kuaishou_order_num)) AS kuaishou_order_num
    FROM
    (
        SELECT
            formatDateTime(ms.pay_time, '%Y-%m') AS month,
            toFloat64(sumIf(ms.order_money,platform_new ='taobao')) AS taobao_gmv,
            toFloat64(sumIf(ms.real_payment,platform_new ='taobao')) AS taobao_fee,
            sumIf(order_num,platform_new ='taobao') AS taobao_order_num,
            
            toFloat64(sumIf(ms.order_money,platform_new ='jingdong')) AS jingdong_gmv,
            toFloat64(sumIf(ms.real_payment,platform_new ='jingdong')) AS jingdong_fee,
            sumIf(order_num,platform_new ='jingdong') AS jingdong_order_num,
            
            toFloat64(sumIf(ms.order_money,platform_new ='suning')) AS suning_gmv,
            toFloat64(sumIf(ms.real_payment,platform_new ='suning')) AS suning_fee,
            sumIf(order_num,platform_new ='suning') AS suning_order_num,
            
            toFloat64(sumIf(ms.order_money,platform_new ='pinduoduo')) AS pinduoduo_gmv,
            toFloat64(sumIf(ms.real_payment,platform_new ='pinduoduo')) AS pinduoduo_fee,
            sumIf(order_num,platform_new ='pinduoduo') AS pinduoduo_order_num,
            
            toFloat64(sumIf(ms.order_money,platform_new ='douyin')) AS douyin_gmv,
            toFloat64(sumIf(ms.real_payment,platform_new ='douyin')) AS douyin_fee,
            sumIf(order_num,platform_new ='douyin') AS douyin_order_num,
            
            toFloat64(sumIf(ms.order_money,platform_new ='kuaishou')) AS kuaishou_gmv,
            toFloat64(sumIf(ms.real_payment,platform_new ='kuaishou')) AS kuaishou_fee,
            sumIf(order_num,platform_new ='kuaishou') AS kuaishou_order_num
        FROM dwd_merchant_settlement_order AS ms
        INNER JOIN dim_store_itm AS ml ON ms.mtlyid = ml.mtlyid
        WHERE ms.settlement_status IN (2, 11) 
        $if(begin_date)$
            AND formatDateTime(ms.pay_time, '%Y-%m-%d') >= $begin_date$
        $else$
            AND formatDateTime(ms.pay_time, '%Y-%m-%d') >= '2021-06'    
        $endif$    
        $if(end_date)$   
            AND formatDateTime(ms.pay_time, '%Y-%m-%d') <= $end_date$
        $else$
            AND ms.pay_time <= now()    
        $endif$    
        GROUP BY formatDateTime(ms.pay_time, '%Y-%m')
    ) AS tmp
    GROUP BY tmp.month
) AS res
GROUP BY month order by month asc;